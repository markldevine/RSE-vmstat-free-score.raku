#!/var/lib/data/raku/maxzef/bin/raku
#!/var/lib/data/raku/bin/raku

use Redis;
use MicroOS::vmstat::record;

my $valkey-list = 'RSE^statistics^' ~ $*KERNEL.hostname ~ '^vmstat^rollingsixty';
my $valkey      = Redis.new("172.19.2.254:6379", :decode_response);
$valkey.del($valkey-list) if $valkey.exists($valkey-list);
$valkey.rpush($valkey-list, (0 xx 60));

#   mdevine@mos01:~> vmstat -y -n -t 1 2
#   procs -----------memory---------- ---swap-- -----io---- -system-- -------cpu------- -----timestamp-----
#    r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st gu                 EST
#    0  0      0 236288   2800 220600    0    0     0     0  563  335  0  0 99  0  0  0 2025-12-03 08:38:29
#    0  0      0 236952   2800 220600    0    0     0     0  532  319  0  0 100 0  0  0 2025-12-03 08:38:30

my $proc = Proc::Async.new('/usr/bin/vmstat', '-y', '-n', '-t', 1);

react {
    whenever $proc.stdout -> $line {
        if $line ~~ /^ \s* \d+ \s+ \d+ \s+ \d+/ {
            my  (
                    $v-r,
                    $v-b,
                    $v-swpd,
                    $v-free,
                    $v-buff,
                    $v-cache,
                    $v-si,
                    $v-so,
                    $v-bi,
                    $v-bo,
                    $v-in,
                    $v-cs,
                    $v-us,
                    $v-sy,
                    $v-id,
                    $v-wa,
                    $v-st,
                    $v-gu,
                    $v-date,
                    $v-time,
                )   = $line.trim.split(/\s+/);
            my MicroOS::vmstat::record $v-record .= new(
                :$v-r,
                :$v-b,
                :$v-swpd,
                :$v-free,
                :$v-buff,
                :$v-cache,
                :$v-si,
                :$v-so,
                :$v-bi,
                :$v-bo,
                :$v-in,
                :$v-cs,
                :$v-us,
                :$v-sy,
                :$v-id,
                :$v-wa,
                :$v-st,
                :$v-gu,
                :$v-date,
                :$v-time,
            );
put $v-record.v-datetime.second;
            $valkey.lset($valkey-list, +$v-record.v-datetime.second, $v-record.marshal) or note 'valkey LSET ' ~ $v-record.v-datetime.second ~ ' failed';
        }
    }

    whenever $proc.stderr -> $err {
        note "Error: {$err.trim}";
        done;
    }

    whenever $proc.start -> $promise {
        whenever $promise -> $status {
            if $status.signal {
                note 'vmstat was killed by signal: ' ~ $status.signal;
            }
            elsif $status.exit {
                note 'vmstat exited normally with code: ' ~ $status.exitcode;
            }
            else {
                note 'vmstat ended unexpectedly';
            }
            done;
        }
    }
}

$valkey.quit;
exit 1;                                                                                         # should never exit...

=finish
